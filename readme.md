# openrepo

OpenRepo - сервер основанный на WEB для управления и размещения репозиториев содержащих Debian apt/deb, Redhat rpm и общие файлы пакетов.

Сервер поддерживает:

  - Генерация RPM, Deb, Generic репозиториев, совместимых с инструментами Debian/Ubuntu apt-get и RedHat yum, и их размещение
  - Загрузка пакетов, удаление, копирование и продвижение (Например, для легкого перемещения пакетов между dev, QA, beta, production репозиториев)
  - Создание и управление ключами подписи PGP
  - Управление версиями
  - Контроль доступа к записи/чтению для пользователей к каждому репозиторию
  - REST API
  - Приложение CLI для интеграции с CI (CLI - Command Line Interface, интерфейс командной строки; CI - Continuous Integration, непрерывная интеграция)


![OpenRepo Demo Video](https://github.com/dushenka/ORPersonal/blob/master/util/doc_images/openrepo-demo.gif?raw=true)

## Начало работы

Предпочтительный способ запуска OpenRepo - это Docker, используя приложенный файл конфигурации docker-compose.yml. Это запустит необходимые сервисы и базу данных PostgreSQL. Все файлы, необходимые к хранению (persistent data files), такие как база данных, кэш, ключи PGP и файлы пакетов, находятся в отдельной папке с именем openrepo-data.

 Для начала убедитесь, что у Вас установлен [Docker](https://docker-docs.netlify.app/install/#server) и [Docker Compose plugin](https://docker-docs.netlify.app/compose/install/)


Чтобы запустить сервер пропишите в терминале:

    wget https://raw.githubusercontent.com/dushenka/ORPersonal/master/docker-compose.yml
    
    docker-compose up -d

Теперь Вы можете зайти на сервер по ссылке http://localhost:80

Стандартно для входа в учетную запись админа используются:

    username    (имя) : admin
    password (пароль) : admin

Если есть желание, можно перенаправить на альтернативный сервер PostgreSQL изменив переменную среды "OPENREPO_PG" в файле docker-compose.


## Применение непрерывной интеграции (CI)

Общим требованием является автоматическая загрузка файлов пакетов, созданных с помощью непрерывной интеграции. См. [OpenRepo Command-Line-Interface documentation](cli/) для большей информации.

Интерфейс командной строки (или REST API) может быть использован чтобы отправлять новые пакеты в репозиторий, а также продвигать и копировать пакеты в другие репозитории.

## Пользователи и права

Существует два типа пользователей:

  1. **Super User** / **Супер пользователь** - Имеет права на чтение и запись во все репозитории, а также доступ к админ-панели для добавления/удаления пользователей, ключей и разрешений.
  2. **Regular User** / **Обычный пользователь** - Имеет право чтения всех репозиториев. Право на запись необходимо получать для каждого репозитория отдельно.

Для добавления нового пользователя:
  1. Будучи супер пользователем нажмите на "System Admin" из выпадающего меню с правого верхнего угла.
  2. Нажмите кнопку "Add" рядом с Users link.
  3. Добавьте **имя** и **пароль** и нажмите "Save".
    - Ключ API создастся автоматически. Это можно удалить, чтобы убрать разрешение на доступ к API.
  4. Чтобы предоставить право записи, нажмите на ссылку "Repositories", затем нажмите на необходимый репозиторий. Добавьте пользователя в список и сохраните.


## REST API


### Действия с репозиториями:

UID репозитория автоматически создается вместе с самим репозиторием.  

    # список имен репозиторие вместе с их UID
    GET /api/repos/

    # показать доп. информацию по репозиторию
    GET /api/<репозиторий>/

    # создать новый репозиторий
    POST /api/repos/

    # удалить репозиторий
    DELETE /api/<репозиторий>/

### Действия с пакетами:

UID пакета автоматически создается при загрузке/копировании пакета в репозиторий.

    # список пакетов конкретного репозитория
    GET /api/<репозиторий>/packages/

    # загрузить пакет в репозиторий
    POST /api/<репозиторий>/upload/

    # удалить пакет в репозитории
    DELETE /api/<репозиторий>/pkg/<пакет>/

    # показать доп. информацию по пакету
    GET /api/<репозиторий>/pkg/<пакет>/

    # скопировать пакет в другой репозиторий
    POST /api/<репозиторий>/pkg/<пакет>/copy/

### Действия с ключами подписи:

ID ключа подписи это отпечаток PGP ключа и создается автоматически, когда ключ загружается или создается.

    # список всех ключей подписи
    GET /api/signingkeys/

    # создать ключ подписи
    POST /api/signingkeys/

    # удалить ключ подписи
    DELETE /api/signingkeys/<ключ подписи>/


# Разработка


## Архитектура

OpenRepo состоит из 4 запущенных процессов:

### Nginx web-сервер

На web-сервере размещены статические содержимые файлов. Это включает в себя содержимое, сгенерированное папкой "frontend" (такие как Vue/Vuetify) а так же изображения и файлы репозиториев.

Web-сервер также служит как прокси для конечных точек Django. Это в основном REST API и панель админа.

Web-порт Nginx единственный порт, который должен быть открыт для сетевого траффика.

### Сервер приложения Django

На сервере приложения размещены REST API, который является основным для вёрстки и CLI для взаимодействия с приложением.  Также здесь хранятся несколько статических страниц (Например, интерфейс админ-панели, форма смены пароля и т.п.), которые проксируются через Django.

### Django worker

Worker запускается как фоновый процесс и коммуницирует только с сервером базы данных. Django worker ответственен за создание мета-данных когда репозиторий обновляется (или когда пакеты загружаются или удаляются). Этот процесс использует инструменты Операционной Системы (ОС) чтобы создавать репозитории и связывать файлы с их соответствующими расположениями. Некоторые инструменты генерации могут использовать для успокрения обновления репозиториев кеш (для хранения таких вещей как хеш-информация).

### База данных

По умолчанию OpenRepo использует базу данных PostgreSQL. Есть возможность использовать и другие базы данных (Например, SQLite для упрощенной разработки), однако PostgreSQL рекомендуется.



## Настрйока окружения разработки

Запуск вышеперечисленных компонентов по отдельности - лучший подход к тестированию модификаций к коду.

Первым шагом стоит добавить файл **web/openrepo/settings_local.py** и применить любое переопределение переменной среды для разработки.  

Например, следующий файл **settings_local.py** настроит Ваше окружение максимально легким для разработки. Однако это лишь пример.


    import os

    os.environ["OPENREPO_VAR_DIR"] = "/var/tmp/openrepo/"
    os.environ["OPENREPO_DEBUG"] = "TRUE"
    os.environ["OPENREPO_DB_TYPE"] = "sqlite"
    os.environ["OPENREPO_LOGLEVEL"] = "DEBUG"


После, откройте 4 независимых вкладки (в терминале) и запустите следующие команды:

    Вкладка 1 : cd web; ./manage.py runserver
    Вкладка 2 : cd web; ./manage.py runworker
    Вкладка 3 : cd frontend; npm run dev
    Вкладка 4 : nginx -c /storage/projects/openrepo/deploy/nginx/nginx.conf.dev


Наконец, проследуйте на http://localhost:5173/ чтобы увидеть ваши изменения. Сервер разработки Vue.js и Django поддерживают обновление по мере изменения кода (в режиме реального времени).  
